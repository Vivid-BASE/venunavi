<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guideboxx | ãƒ©ã‚¤ãƒ–å‚æˆ¦ç®¡ç†</title>
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #341f97;
            --primary-light: #5f27cd;
            --accent: #ff9f43;
            --text-main: #333;
            --text-light: #777;
            --bg-body: #f7f7f7;
            --white: #ffffff;
            --radius-card: 16px;
            --shadow-card: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: "M PLUS Rounded 1c", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
        }

        .header {
            background: var(--primary-bg);
            color: var(--white);
            padding: 15px 20px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header .title {
            flex-grow: 1;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius-card);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
        }

        .section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-bg);
            font-weight: 700;
            border-left: 5px solid var(--accent);
            padding-left: 10px;
        }

        .ticket-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ticket {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-card);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .ticket-left {
            background: var(--primary-bg);
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-width: 70px;
            text-align: center;
            border-right: 2px dashed rgba(255, 255, 255, 0.3);
        }

        .ticket-right {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .btn {
            border: none;
            outline: none;
            cursor: pointer;
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: bold;
            font-size: 1rem;
            transition: transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background: var(--primary-bg);
            color: white;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            background: #f9f9f9;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            color: #999;
            flex: 1;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .nav-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--primary-bg);
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        .text-c {
            text-align: center;
        }

        .japan-map-wrapper {
            display: flex;
            justify-content: center;
            padding: 10px 0;
        }

        .japan-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 3px;
        }

        .pref-box {
            width: 18px;
            height: 18px;
            background: #ddd;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #555;
        }

        .pref-box.visited {
            background: var(--accent);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 5px rgba(255, 159, 67, 0.5);
            cursor: pointer;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff9f43;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #reviewBox {
            background: #e8f0fe;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .review-addr {
            font-weight: bold;
            color: #1a73e8;
            margin: 5px 0 10px 0;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Review Box Buttons */
        .review-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            box-sizing: border-box;
            font-size: 1rem;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="title">ğŸ“ ã¹ã«ã‚…ãªã³</div>
    </header>

    <main id="view-home" class="container">

        <div
            style="background:#fff; padding:20px; border-radius:12px; border:1px solid #eee; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <h3 style="margin-top:0; color:var(--primary-bg);">ğŸ“… æ¬¡ã®ãƒ©ã‚¤ãƒ–äºˆå®š</h3>

            <p style="font-size:0.8rem; color:#666;">
                æ—¥ä»˜ã¨ä¼šå ´åã‚’å…¥ã‚Œã‚‹ã ã‘ã§ã€å½“æ—¥ã®ã‚¹ã‚¿ãƒ³ãƒ—å ´æ‰€ãŒã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
            </p>

            <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:4px;">ğŸ“… æ—¥ä»˜</label>
                        <input type="date" id="planDate"
                            style="width:100%; height:45px; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; -webkit-appearance: none; background:white;">
                    </div>
                    <div style="flex:2;">
                        <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:4px;">ğŸ¤ ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
                        <input type="text" id="planInputArtist" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå"
                            style="width:100%; height:45px; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
                    </div>
                </div>
                <div>
                    <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:4px;">ğŸŸï¸ ä¼šå ´å</label>
                    <input type="text" id="planVenue" placeholder="ä¼šå ´å (ä¾‹: Zepp Haneda)"
                        style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
                </div>
                <textarea id="planMemo" placeholder="ãƒ¡ãƒ¢ (å‚™è€ƒ/æ•´ç†ç•ªå·ãªã©)"
                    style="padding:10px; border:1px solid #ddd; border-radius:8px; height:60px;"></textarea>
            </div>

            <button id="registerBtn" onclick="startSearch()"
                style="width:100%; background:var(--primary-bg); color:white; padding:15px; border:none; border-radius:30px; font-weight:bold; cursor:pointer; box-shadow:0 4px 10px rgba(52, 31, 151, 0.3);">
                ğŸ” å ´æ‰€ã‚’æ¤œç´¢
            </button>

            <!-- REVIEW BOX -->
            <div id="reviewBox">
                <!-- Removed "Correction Candidate" (official name) as requested -->
                <div style="font-size:0.9rem; color:#333; font-weight:bold; margin-bottom:5px;">ğŸ“ ã“ã¡ã‚‰ã®å ´æ‰€ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
                <div id="reviewAddress" class="review-addr" style="font-weight:normal; margin-bottom:15px; color:#555;">
                </div>

                <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
                    <button onclick="confirmPlan()" class="review-btn"
                        style="background:var(--primary-bg); color:white;">
                        ã¯ã„ã€ç™»éŒ²ã—ã¾ã™
                    </button>
                    <button onclick="showManualFix()" class="review-btn"
                        style="background:#f1f2f6; color:#555; border:1px solid #ddd;">
                        ã„ã„ãˆã€ä¿®æ­£ã—ã¾ã™ (æ‰‹å‹•å…¥åŠ›)
                    </button>
                    <a id="reviewMapLink" href="#" target="_blank" class="review-btn"
                        style="background:#fff; border:none; color:#1a73e8; font-size:0.9rem; margin-top:5px; text-decoration:underline;">
                        ğŸ—ºï¸ Googleãƒãƒƒãƒ—ã§ä½ç½®ã‚’ç¢ºèª
                    </a>
                </div>
            </div>

            <!-- MANUAL FIX AREA -->
            <div id="fallbackArea"
                style="display:none; background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #ffeeba; margin-top:10px;">
                <p style="margin:0 0 10px 0; color:#856404; font-size:1.0rem; font-weight:bold;">ğŸ“ æ‰‹å‹•ã§å ´æ‰€ã‚’ç™»éŒ²</p>
                <div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <button onclick="openGoogleSearch()"
                        style="width:100%; background:#eee; border:none; padding:8px; border-radius:4px; font-weight:bold; cursor:pointer; margin-bottom:5px;">ğŸ”
                        Googleãƒãƒƒãƒ—ã‚’é–‹ã</button>
                    <div style="font-size:0.9rem;">æ­£ã—ã„<strong>ã€Œä½æ‰€ã€</strong>ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€<br>ã“ã®ä¸‹ã®ç®±ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</div>
                </div>
                <textarea id="fallbackInput" placeholder="ä½æ‰€ã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ"
                    style="width:100%; padding:10px; height:60px; border:2px solid #d35400; border-radius:8px; box-sizing:border-box; background:#fff0e6; font-size:1rem;"></textarea>
                <button id="retryBtn" onclick="retrySearch()"
                    style="width:100%; background:#d35400; color:white; padding:12px; border:none; border-radius:30px; font-weight:bold; cursor:pointer; font-size:1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">ğŸ‘‰
                    ã“ã‚Œã§ç™»éŒ²ã™ã‚‹</button>
            </div>

            <div id="missionList" style="margin-top:20px;"></div>
        </div>

        <!-- EDIT PLAN MODAL -->
        <div id="editModal" class="modal-overlay">
            <div class="modal-content">
                <h3 style="margin-top:0; color:var(--primary-bg);">âœï¸ äºˆå®šã‚’ç·¨é›†</h3>
                <input type="hidden" id="editPlanId">
                <label style="font-size:0.8rem; color:#666;">æ—¥ä»˜</label>
                <input type="date" id="editDate" class="form-input" style="margin-bottom:10px;">
                <label style="font-size:0.8rem; color:#666;">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
                <input type="text" id="editArtist" class="form-input" style="margin-bottom:10px;">
                <label style="font-size:0.8rem; color:#666;">ä¼šå ´å (è¡¨ç¤ºç”¨)</label>
                <input type="text" id="editVenue" class="form-input" style="margin-bottom:10px;">
                <label style="font-size:0.8rem; color:#666;">ãƒ¡ãƒ¢</label>
                <textarea id="editMemo" class="form-input" style="height:80px; margin-bottom:15px;"></textarea>
                <div style="display:flex; justify-content:space-between; gap:10px;">
                    <button onclick="closeEditModal()"
                        style="background:#ccc; color:white; border:none; padding:10px; border-radius:8px; flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="saveEditPlan()"
                        style="background:var(--primary-bg); color:white; border:none; padding:10px; border-radius:8px; flex:1; font-weight:bold;">ä¿å­˜</button>
                </div>
                <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                    <div style="font-size:0.8rem; color:#d35400; cursor:pointer; text-align:center; text-decoration:underline;"
                        onclick="closeEditModal(); updatePlanLocation(currentEditId)">ğŸ“ å ´æ‰€(åœ°å›³)ã ã‘ä¿®æ­£ã—ãŸã„å ´åˆã¯ã“ã¡ã‚‰</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ—¾ å…¨å›½åˆ¶è¦‡ãƒãƒƒãƒ—</div>
            <p class="text-s text-c text-gray" style="font-size:0.8rem;">ã‚ªãƒ¬ãƒ³ã‚¸ã®éƒ½é“åºœçœŒã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ä¸‹ã«å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™</p>
            <div class="japan-map-wrapper">
                <div class="japan-grid" id="japanGridTarget"></div>
            </div>
            <div style="text-align:center; margin-top:10px; font-weight:bold; color:var(--primary-bg);">
                åˆ¶è¦‡: <span id="conquerCount" style="font-size:1.5rem; color:var(--accent);">0</span> / 47
            </div>

            <div id="prefHistoryArea"
                style="margin-top:20px; display:none; border-top:1px solid #eee; padding-top:15px;">
                <h4 id="prefHistoryTitle" style="color:var(--primary-bg); margin:0 0 10px 0;"></h4>
                <div id="prefHistoryList"></div>
                <button onclick="document.getElementById('prefHistoryArea').style.display='none'"
                    style="width:100%; background:#f0f0f0; border:none; padding:8px; border-radius:8px; margin-top:10px; color:#555;">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </main>

    <main id="view-history" class="container hidden">
        <div class="section-title" style="margin-bottom:20px;">ğŸ« å‚æˆ¦å±¥æ­´</div>
        <div id="historyContainer" class="ticket-list"></div>
    </main>

    <main id="view-search" class="container hidden">
        <div class="card">
            <div class="section-title">ğŸ” ä¼šå ´å‘¨è¾ºãƒ»è¨­å‚™</div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="venueInput" class="form-input" placeholder="ä¼šå ´å (ä¾‹: Zepp Haneda)"
                    onkeypress="if(event.key==='Enter') searchLegacyVenue(this.value)">
                <button onclick="searchLegacyVenue(document.getElementById('venueInput').value)"
                    style="background:var(--primary-bg); color:white; border:none; border-radius:8px; padding:0 20px; cursor:pointer; font-weight:bold;">ğŸ”</button>
            </div>
            <div id="legacyContent" style="padding:20px;"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')" id="nav-home"><span class="nav-icon">ğŸ </span>ãƒã‚¤ãƒšãƒ¼ã‚¸
        </div>
        <div class="nav-item" onclick="switchTab('search')" id="nav-search"><span class="nav-icon">ğŸ”</span>å‘¨è¾ºæƒ…å ±</div>
        <div class="nav-item" onclick="switchTab('history')" id="nav-history"><span class="nav-icon">ğŸ«</span>å±¥æ­´</div>
    </nav>

    <script src="venues_database.js"></script>
    <script>if (typeof VENUES_DATABASE === 'undefined') { var VENUES_DATABASE = { "Zepp Haneda": { name: "Zepp Haneda", Lat: 35.5457, Lng: 139.7423, tabs: { luggage: { title: "L", content: "" } } } } }</script>

    <script>
        const PLAN_KEY = 'guideboxx_plans';
        let pendingLocation = null;
        let currentEditId = null;

        async function startSearch() {
            const dateVal = document.getElementById('planDate').value;
            const venueVal = document.getElementById('planVenue').value;
            if (!dateVal || !venueVal) { alert("æ—¥ä»˜ã¨ä¼šå ´åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            const btn = document.getElementById('registerBtn');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerHTML = '<span class="loader"></span> æ¤œç´¢ä¸­...';

            document.getElementById('reviewBox').style.display = 'none';
            document.getElementById('fallbackArea').style.display = 'none';

            let loc = await robustSearch(venueVal);

            btn.disabled = false; btn.innerText = originalText;

            if (loc) {
                showReview(loc);
            } else {
                showManualFix();
            }
        }

        function showReview(loc) {
            pendingLocation = loc;
            document.getElementById('reviewBox').style.display = 'block';
            document.getElementById('reviewAddress').innerText = loc.addressLabel || loc.region;
            document.getElementById('reviewMapLink').href = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lon}`;

            const nameEl = document.getElementById('reviewVenueName');
            if (loc.officialName) {
                nameEl.innerHTML = `ä¿®æ­£å€™è£œ: <strong>${loc.officialName}</strong><br><span style="font-size:0.8rem; font-weight:normal; color:#666;">â€»ç™»éŒ²æ™‚ã«ã“ã®åå‰ã«è‡ªå‹•ä¿®æ­£ã•ã‚Œã¾ã™</span>`;
                nameEl.style.display = 'block';
            } else {
                nameEl.style.display = 'none';
            }
        }

        function confirmPlan() {
            if (!pendingLocation) return;
            const dateVal = document.getElementById('planDate').value;
            let venueVal = document.getElementById('planVenue').value;
            const artistVal = document.getElementById('planInputArtist').value;
            const memoVal = document.getElementById('planMemo').value;

            if (pendingLocation.officialName) {
                venueVal = pendingLocation.officialName;
            }

            finalizePlan(dateVal, venueVal, artistVal, memoVal, pendingLocation.lat, pendingLocation.lon, pendingLocation.region, pendingLocation.isRough);
            document.getElementById('reviewBox').style.display = 'none';
            document.getElementById('planVenue').value = "";
            document.getElementById('planInputArtist').value = "";
            document.getElementById('planMemo').value = "";
            pendingLocation = null;
        }

        function showManualFix() { const venueVal = document.getElementById('planVenue').value; if (venueVal) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(venueVal)}`, '_blank'); document.getElementById('reviewBox').style.display = 'none'; document.getElementById('fallbackArea').style.display = 'block'; }

        async function retrySearch() {
            const rawText = document.getElementById('fallbackInput').value;
            const dateVal = document.getElementById('planDate').value;
            const venueVal = document.getElementById('planVenue').value;
            const artistVal = document.getElementById('planInputArtist').value;
            const memoVal = document.getElementById('planMemo').value;

            if (!rawText) { alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            const btn = document.getElementById('retryBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loader"></span> è§£æä¸­...';

            const cleanQuery = cleanAddressText(rawText);
            let loc = await robustSearch(cleanQuery);

            btn.disabled = false; btn.innerText = "ğŸ‘‰ ã“ã‚Œã§ç™»éŒ²ã™ã‚‹";

            if (loc) {
                finalizePlan(dateVal, venueVal, artistVal, memoVal, loc.lat, loc.lon, loc.region, loc.isRough);
                document.getElementById('fallbackArea').style.display = 'none';
                document.getElementById('fallbackInput').value = "";
                document.getElementById('planVenue').value = "";
                document.getElementById('planInputArtist').value = "";
                document.getElementById('planMemo').value = "";
            } else {
                alert("å ´æ‰€ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\néƒ½é“åºœçœŒåã‚’å«ã‚ãŸä½æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function findBestVenueMatch(input) {
            if (typeof VENUES_DATABASE === 'undefined') return null;
            const normalize = (str) => {
                return str.toLowerCase()
                    .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                    .replace(/[\sã€€]/g, '');
            };
            const target = normalize(input);
            const aliases = { "æ±äº¬ãƒ‰ãƒ¼ãƒ ã‚·ãƒ†ã‚£ãƒ›ãƒ¼ãƒ«": "ã‚«ãƒŠãƒ‡ãƒ“ã‚¢ãƒ›ãƒ¼ãƒ«", "TDC": "ã‚«ãƒŠãƒ‡ãƒ“ã‚¢ãƒ›ãƒ¼ãƒ«", "ãƒãƒªãƒãƒª": "æ»‹è³€ãƒãƒªãƒãƒª", "zepphaneda": "Zepp Haneda", "zeppshinjuku": "Zepp Shinjuku", "æ¨ªã‚¢ãƒª": "æ¨ªæµœã‚¢ãƒªãƒ¼ãƒŠ", "ãŸã¾ã‚¢ãƒª": "ã•ã„ãŸã¾ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒªãƒ¼ãƒŠ" };
            if (aliases[target]) return VENUES_DATABASE[aliases[target]];
            const keys = Object.keys(VENUES_DATABASE);
            for (const key of keys) { if (normalize(key) === target) return VENUES_DATABASE[key]; }
            if (target.length > 3) { for (const key of keys) { if (normalize(key).includes(target)) return VENUES_DATABASE[key]; } }
            return null;
        }

        async function robustSearch(query) {
            const coordMatch = query.match(/([0-9.]+)\s*,\s*([0-9.]+)/);
            if (coordMatch) { const lat = parseFloat(coordMatch[1]); const lng = parseFloat(coordMatch[2]); if (!isNaN(lat) && !isNaN(lng)) return { lat: lat, lon: lng, region: "åº§æ¨™æŒ‡å®š", addressLabel: `æŒ‡å®šåº§æ¨™: ${lat}, ${lng}`, isRough: false }; }
            const dbObj = findBestVenueMatch(query);
            if (dbObj) { return { lat: dbObj.lat, lon: dbObj.lng, region: dbObj.region, addressLabel: `${dbObj.region} (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç™»éŒ²æ¸ˆã¿)`, officialName: dbObj.name, isRough: false }; }
            const searchPromise = new Promise(async (resolve) => { const p1 = searchAPI_Photon(query); const p2 = searchAPI_Nominatim(query); const res = await Promise.any([p1.then(r => r ? r : Promise.reject()), p2.then(r => r ? r : Promise.reject())]).catch(() => null); resolve(res); });
            const timeoutPromise = new Promise(resolve => setTimeout(() => resolve(null), 5000));
            let res = await Promise.race([searchPromise, timeoutPromise]);
            if (res) return res;
            let subQuery = query; let loopCount = 0;
            while (subQuery.length > 5 && /\d$/.test(subQuery) && loopCount < 3) { subQuery = subQuery.replace(/[-\d]+$/, ''); if (subQuery === query) break; const fbRes = await searchAPI_Nominatim(subQuery); if (fbRes) return { ...fbRes, isRough: true }; query = subQuery; loopCount++; }
            return null;
        }

        async function searchAPI_Nominatim(q) {
            try { const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&countrycodes=jp&limit=1`; const r = await fetch(url); const d = await r.json(); if (d && d.length > 0) { const addr = d[0].address; const region = addr.province || addr.state || "ãã®ä»–"; let label = region; if (addr.city) label += addr.city; if (addr.town) label += addr.town; let detectedName = null; if (d[0].name) detectedName = d[0].name; return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon), region: region, addressLabel: label, officialName: detectedName }; } } catch (e) { return null; } return null;
        }

        async function searchAPI_Photon(q) {
            try { const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&limit=1`; const r = await fetch(url); const d = await r.json(); if (d && d.features && d.features.length > 0) { const f = d.features[0]; const props = f.properties; const region = props.state || props.city || "ãã®ä»–"; let label = region; if (props.city && region !== props.city) label += props.city; return { lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0], region: region, addressLabel: label, officialName: props.name }; } } catch (e) { return null; } return null;
        }

        function finalizePlan(date, venue, artist, memo, lat, lng, region, isRough) {
            const newPlan = { id: Date.now(), date: date, venue: venue, artist: artist || "", memo: memo || "", region: region, lat: lat, lng: lng, isRough: isRough || false, completed: false };
            const plans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            plans.push(newPlan);
            plans.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem(PLAN_KEY, JSON.stringify(plans));
            renderMissions();
            alert(`ç™»éŒ²ã—ã¾ã—ãŸï¼\nï¼ˆ${region}ï¼‰\nâ€»ä½ç½®ãŒå°‘ã—ãšã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç§»å‹•æ™‚ã¯æ”¹ã‚ã¦æ¤œç´¢æ¨å¥¨`);
        }

        function renderMissions() {
            const list = document.getElementById('missionList'); if (!list) return;
            const plans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            list.innerHTML = "";
            const today = new Date().toISOString().split('T')[0];

            if (plans.filter(p => !p.completed).length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#999; font-size:0.9rem;">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div>`;
                return;
            }

            plans.forEach(plan => {
                if (plan.completed) return;
                const isToday = (plan.date <= today);
                let btnHtml = isToday ? `<button onclick="checkIn(${plan.id})" style="background:#ff4757; color:white; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; cursor:pointer;">ğŸ ã‚¹ã‚¿ãƒ³ãƒ—GET</button>` : `<button disabled style="background:#ccc; color:white; border:none; padding:8px 15px; border-radius:20px; font-size:0.8rem;">å½“æ—¥ã¾ã§å¾…æ©Ÿ</button>`;

                const mapLink = `<a href="https://www.google.com/maps/search/?api=1&query=${plan.lat},${plan.lng}" target="_blank" style="font-size:0.8rem; color:var(--primary-bg); text-decoration:underline; display:inline-block; margin-right:10px;">ğŸ“åœ°å›³ã§ç¢ºèª</a>`;
                const editAction = `<span onclick="openEditModal(${plan.id})" style="font-size:0.8rem; cursor:pointer; color:#777; text-decoration:underline; margin-right:10px;">âœï¸ ç·¨é›†</span>`;
                const deleteAction = `<span onclick="deletePlan(${plan.id})" style="font-size:0.8rem; cursor:pointer; color:#999; text-decoration:underline;">ğŸ—‘ï¸å‰Šé™¤</span>`;

                let artistHtml = plan.artist ? `<div style="font-weight:bold; color:#444;">ğŸ¤ ${plan.artist}</div>` : '';
                let memoHtml = plan.memo ? `<div style="font-size:0.8rem; color:#666; background:#eee; padding:5px; border-radius:4px; margin-top:5px;">ğŸ“ ${plan.memo}</div>` : '';

                list.innerHTML += `
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid ${isToday ? '#ff4757' : '#ccc'};">
                    <div style="flex:1;">
                        <div style="font-size:0.8rem; color:#666;">${plan.date}</div>
                        ${artistHtml}
                        <div style="font-weight:bold; font-size:1.1rem; color:var(--primary-bg);">${plan.venue}</div>
                        ${memoHtml}
                        <div style="margin-top:6px;">${mapLink}${editAction}${deleteAction}</div>
                    </div>
                    <div style="margin-left:10px;">${btnHtml}</div>
                </div>`;
            });
        }

        function openEditModal(id) {
            const plans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            const target = plans.find(p => p.id === id);
            if (!target) return;
            currentEditId = id;
            document.getElementById('editPlanId').value = id;
            document.getElementById('editDate').value = target.date;
            document.getElementById('editArtist').value = target.artist || "";
            document.getElementById('editVenue').value = target.venue;
            document.getElementById('editMemo').value = target.memo || "";
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() { document.getElementById('editModal').style.display = 'none'; currentEditId = null; }

        function saveEditPlan() {
            const id = parseInt(document.getElementById('editPlanId').value);
            const newDate = document.getElementById('editDate').value;
            const newArtist = document.getElementById('editArtist').value;
            const newVenue = document.getElementById('editVenue').value;
            const newMemo = document.getElementById('editMemo').value;
            if (!newDate || !newVenue) { alert("æ—¥ä»˜ã¨ä¼šå ´åã¯å¿…é ˆã§ã™"); return; }
            let plans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]");
            let target = plans.find(p => p.id === id);
            if (target) {
                target.date = newDate; target.artist = newArtist; target.venue = newVenue; target.memo = newMemo;
                plans.sort((a, b) => new Date(a.date) - new Date(b.date));
                localStorage.setItem(PLAN_KEY, JSON.stringify(plans));
                renderMissions(); closeEditModal(); alert("å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
            }
        }

        function cleanAddressText(text) { var s = text.replace(/[ï¼-ï¼™]/g, function (s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0); }); if (s.match(/[\d.]+,[\d.]+/)) return s; const prefs = ["åŒ—æµ·é“", "é’æ£®", "å²©æ‰‹", "å®®åŸ", "ç§‹ç”°", "å±±å½¢", "ç¦å³¶", "èŒ¨åŸ", "æ ƒæœ¨", "ç¾¤é¦¬", "åŸ¼ç‰", "åƒè‘‰", "æ±äº¬", "ç¥å¥ˆå·", "æ–°æ½Ÿ", "å¯Œå±±", "çŸ³å·", "ç¦äº•", "å±±æ¢¨", "é•·é‡", "å²é˜œ", "é™å²¡", "æ„›çŸ¥", "ä¸‰é‡", "æ»‹è³€", "äº¬éƒ½", "å¤§é˜ª", "å…µåº«", "å¥ˆè‰¯", "å’Œæ­Œå±±", "é³¥å–", "å³¶æ ¹", "å²¡å±±", "åºƒå³¶", "å±±å£", "å¾³å³¶", "é¦™å·", "æ„›åª›", "é«˜çŸ¥", "ç¦å²¡", "ä½è³€", "é•·å´", "ç†Šæœ¬", "å¤§åˆ†", "å®®å´", "é¹¿å…å³¶", "æ²–ç¸„"]; for (let p of prefs) { const idx = s.indexOf(p); if (idx !== -1) { let line = s.substring(idx).split('\n')[0].trim(); const match = line.match(/(.+?\d+[-\d]*)/); if (match) return match[1]; return line; } } return s.trim(); }
        function openGoogleSearch() { const v = document.getElementById('planVenue').value; window.open(`https://www.google.com/search?q=${encodeURIComponent(v + " ä½æ‰€")}`, '_blank'); }
        function deletePlan(id) { if (!confirm("ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; let plans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]"); plans = plans.filter(p => p.id !== id); localStorage.setItem(PLAN_KEY, JSON.stringify(plans)); renderMissions(); }
        async function updatePlanLocation(id) { const raw = prompt("ã€å ´æ‰€ã®ä¿®æ­£ã€‘\næ­£ã—ã„ã€Œä½æ‰€ã€ã¾ãŸã¯ã€Œæ•°å­—(35.xx, 139.xx)ã€ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"); if (!raw) return; const cleanQuery = cleanAddressText(raw); alert("æ¤œç´¢ä¸­..."); let loc = await robustSearch(cleanQuery); if (loc) { let plans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]"); let target = plans.find(p => p.id === id); if (target) { target.lat = loc.lat; target.lng = loc.lon; target.region = loc.region; target.isRough = loc.isRough || false; localStorage.setItem(PLAN_KEY, JSON.stringify(plans)); alert(`ä¿®æ­£å®Œäº†ï¼\næ–°ã—ã„å ´æ‰€ï¼š${loc.region}`); renderMissions(); } } else { alert("æŒ‡å®šã•ã‚ŒãŸä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ..."); } }
        function checkIn(planId) { const plans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]"); const plan = plans.find(p => p.id === planId); if (!plan) return; if (!navigator.geolocation) { alert("GPSåˆ©ç”¨ä¸å¯"); return; } navigator.geolocation.getCurrentPosition((pos) => { const d = getDistance(pos.coords.latitude, pos.coords.longitude, plan.lat, plan.lng); const threshold = plan.isRough ? 3.0 : 1.0; if (d <= threshold) completeMission(plan); else alert(`âŒ ä¼šå ´ã‹ã‚‰é ã™ãã¾ã™ï¼ˆã‚ã¨ç´„${d.toFixed(1)}kmï¼‰\nâ€»åˆ¤å®šç¯„å›²: ${threshold}kmä»¥å†…`); }, () => alert("GPSå–å¾—å¤±æ•—")); }

        function completeMission(plan) {
            const stamp = { venue: plan.venue, artist: plan.artist || "", memo: plan.memo || "", region: plan.region, displayRegion: plan.region, date: new Date().toLocaleString('ja-JP') };
            const history = JSON.parse(localStorage.getItem('guideboxx_stamps') || "[]"); history.unshift(stamp); localStorage.setItem('guideboxx_stamps', JSON.stringify(history));
            const plans = JSON.parse(localStorage.getItem(PLAN_KEY) || "[]"); const target = plans.find(p => p.id === plan.id); if (target) target.completed = true; localStorage.setItem(PLAN_KEY, JSON.stringify(plans));
            alert("ğŸ‰ ã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆï¼"); renderMissions(); renderJapanMap(); loadStampHistory();
        }

        function getDistance(lat1, lng1, lat2, lng2) { const R = 6371; const dLat = (lat2 - lat1) * (Math.PI / 180); const dLng = (lng2 - lng1) * (Math.PI / 180); const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLng / 2) * Math.sin(dLng / 2); return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))); }

        const japanGridData = [["åŒ—æµ·é“", 1, 14, 3, 2], ["é’æ£®", 3, 13, 1, 1], ["ç§‹ç”°", 4, 12, 1, 1], ["å²©æ‰‹", 4, 13, 1, 1], ["å±±å½¢", 5, 12, 1, 1], ["å®®åŸ", 5, 13, 1, 1], ["ç¦å³¶", 6, 13, 1, 1], ["ç¾¤é¦¬", 7, 12, 1, 1], ["æ ƒæœ¨", 7, 13, 1, 1], ["èŒ¨åŸ", 8, 14, 1, 1], ["åŸ¼ç‰", 8, 12, 1, 1], ["æ±äº¬", 9, 12, 1, 1], ["åƒè‘‰", 9, 13, 1, 1], ["ç¥å¥ˆå·", 9, 11, 1, 1], ["æ–°æ½Ÿ", 6, 11, 1, 1], ["å¯Œå±±", 6, 10, 1, 1], ["é•·é‡", 7, 11, 1, 1], ["å±±æ¢¨", 8, 11, 1, 1], ["çŸ³å·", 5, 9, 1, 1], ["ç¦äº•", 6, 9, 1, 1], ["å²é˜œ", 7, 10, 1, 1], ["é™å²¡", 9, 10, 1, 1], ["æ„›çŸ¥", 8, 9, 1, 1], ["æ»‹è³€", 7, 9, 1, 1], ["ä¸‰é‡", 9, 9, 1, 1], ["äº¬éƒ½", 7, 8, 1, 1], ["å¥ˆè‰¯", 8, 8, 1, 1], ["å’Œæ­Œå±±", 9, 8, 1, 1], ["å¤§é˜ª", 8, 7, 1, 1], ["å…µåº«", 7, 7, 1, 1], ["é³¥å–", 7, 6, 1, 1], ["å²¡å±±", 8, 6, 1, 1], ["å³¶æ ¹", 7, 5, 1, 1], ["åºƒå³¶", 8, 5, 1, 1], ["å±±å£", 8, 4, 1, 1], ["é¦™å·", 9, 6, 1, 1], ["å¾³å³¶", 10, 7, 1, 1], ["æ„›åª›", 10, 5, 1, 1], ["é«˜çŸ¥", 11, 6, 1, 1], ["ç¦å²¡", 8, 3, 1, 1], ["å¤§åˆ†", 9, 3, 1, 1], ["ä½è³€", 9, 2, 1, 1], ["é•·å´", 9, 1, 1, 1], ["ç†Šæœ¬", 10, 2, 1, 1], ["å®®å´", 11, 3, 1, 1], ["é¹¿å…å³¶", 11, 2, 1, 1], ["æ²–ç¸„", 13, 1, 1, 1]];

        function renderJapanMap() {
            const container = document.getElementById("japanGridTarget"); if (!container) return;
            container.innerHTML = "";
            const history = JSON.parse(localStorage.getItem('guideboxx_stamps') || "[]");
            const conquered = new Set(history.map(h => { const reg = h.displayRegion || h.prefecture || h.region || ""; return reg.replace(/[éƒ½åºœçœŒ]/g, ''); }));

            japanGridData.forEach(item => {
                const [name, r, c, w, h] = item;
                const cell = document.createElement("div");
                cell.className = "pref-box";
                cell.innerText = name[0];
                cell.style.gridRow = `${r} / span ${h}`;
                cell.style.gridColumn = `${c} / span ${w}`;
                if (conquered.has(name)) {
                    cell.classList.add("visited");
                    cell.onclick = () => showPrefHistory(name);
                }
                container.appendChild(cell);
            });
            const el = document.getElementById('conquerCount'); if (el) el.innerText = conquered.size;
        }

        // --- PREFECTURE HISTORY (INLINE) ---
        function showPrefHistory(prefName) {
            const history = JSON.parse(localStorage.getItem('guideboxx_stamps') || "[]");
            const targets = history.filter(h => {
                const reg = h.displayRegion || h.prefecture || h.region || "";
                return reg.includes(prefName);
            });

            const area = document.getElementById("prefHistoryArea");
            const titleEl = document.getElementById("prefHistoryTitle");
            const listEl = document.getElementById("prefHistoryList");

            titleEl.innerText = `${prefName}ã®ã‚¹ã‚¿ãƒ³ãƒ— (${targets.length})`;
            listEl.innerHTML = "";

            targets.forEach(t => {
                let memoHtml = t.memo ? `<div style="font-size:0.8rem; color:#666; background:#fff; padding:5px; border-radius:4px; margin-top:5px;">ğŸ“ ${t.memo}</div>` : '';
                let html = `
                <div style="background:#fffcf5; padding:12px; border-radius:8px; margin-bottom:10px; border-left:4px solid var(--accent); box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                         <div style="font-size:0.8rem; color:#888;">${t.date.split(' ')[0]}</div>
                         <div style="font-size:0.8rem; font-weight:bold; color:var(--primary-bg);">${t.venue}</div>
                    </div>
                    ${t.artist ? `<div style="font-weight:bold; color:#444; margin-bottom:5px;">ğŸ¤ ${t.artist}</div>` : ""}
                    ${memoHtml}
                </div>`;
                listEl.innerHTML += html;
            });
            area.style.display = "block";
        }

        function loadStampHistory() {
            const history = JSON.parse(localStorage.getItem('guideboxx_stamps') || "[]");
            const container = document.getElementById('historyContainer');
            if (!container) return;
            container.innerHTML = '';

            if (history.length === 0) {
                container.innerHTML = '<div class="text-c text-gray">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            history.forEach(item => {
                const venue = item.venue;
                const date = item.date.split(' ')[0]; // Show date only
                const reg = item.displayRegion || item.region;

                let memoHtml = item.memo ? `<div style="font-size:0.8rem; color:#666; background:#f9f9f9; padding:5px; border-radius:4px; margin-top:5px; border:1px solid #eee;">ğŸ“ ${item.memo}</div>` : '';
                let artistHtml = item.artist ? `<div style="font-weight:bold; color:#555; font-size:0.9rem; margin-top:2px;">ğŸ¤ ${item.artist}</div>` : '';

                container.innerHTML += `
                <div class="ticket">
                    <div class="ticket-left"><div>æ¸ˆ</div></div>
                    <div class="ticket-right">
                        <div style="font-size:0.8rem; color:#888;">${date}</div>
                        <div class="ticket-artist" style="color:var(--primary-bg); font-size:1.1rem;">${venue}</div>
                        <div style="font-size:0.8rem; color:#777; margin-bottom:4px;">ğŸ“ ${reg}</div>
                        ${artistHtml}
                        ${memoHtml}
                    </div>
                </div>`;
            });
        }

        function switchTab(tab) { document.querySelectorAll('main').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${tab}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${tab}`).classList.add('active'); if (tab === 'home') { renderMissions(); renderJapanMap(); } if (tab === 'history') loadStampHistory(); window.scrollTo(0, 0); }

        // --- LEGACY SEARCH (Surrounding Info) ---
        function searchLegacyVenue(keyword) {
            if (!keyword) return;
            // No strict dependency on database anymore
            let target = keyword;

            // Try to find in database if it exists (for alias handling)
            let venueData = null;
            if (typeof VENUES_DATABASE !== 'undefined') {
                const normalize = (str) => str.toLowerCase().replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[\sã€€]/g, '');
                const safeTarget = normalize(target);
                const keys = Object.keys(VENUES_DATABASE);
                for (const k of keys) {
                    if (normalize(k).includes(safeTarget)) { venueData = VENUES_DATABASE[k]; break; }
                }
                if (!venueData && VENUES_DATABASE[target]) venueData = VENUES_DATABASE[target];
            }

            // If not found, create a dummy object using the input keyword
            if (!venueData) {
                venueData = {
                    name: target,
                    tabs: {} // Empty tabs, but renderLegacyTabs now handles this by defaulting keys
                };
            }

            const container = document.getElementById("legacyContent");
            // Always render content now
            container.innerHTML = `<div style="padding:15px;"><h3 style="color:var(--primary-bg); margin-top:0;">${venueData.name}</h3><div id="legacyTabContainer" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;"></div><div id="legacyTabContent" style="background:#f9f9f9; padding:15px; border-radius:8px;"></div></div>`;
            renderLegacyTabs(venueData);
        }

        function renderLegacyTabs(data) {
            // Even if data.tabs is empty, we force the standard 5 keys
            const tabContainer = document.getElementById("legacyTabContainer");
            const tabContent = document.getElementById("legacyTabContent");
            if (!tabContainer || !tabContent) return;

            // Keys are fixed now to ensure buttons always appear
            const keys = ["parking", "luggage", "timekill", "toilet", "performers"];

            // Updated Meta to match Database Keys (timekill, performers)
            const tabMeta = {
                parking: { icon: "ğŸ…¿ï¸", label: "é§è»Šå ´", color: "#3498db" },
                luggage: { icon: "ğŸ›…", label: "ãƒ­ãƒƒã‚«ãƒ¼", color: "#e67e22" },
                timekill: { icon: "â˜•", label: "ã‚«ãƒ•ã‚§", color: "#2ecc71" },
                toilet: { icon: "ğŸš»", label: "ãƒˆã‚¤ãƒ¬", color: "#9b59b6" },
                performers: { icon: "ğŸ¸", label: "æ¥½å™¨å±‹", color: "#e74c3c" }
            };

            keys.forEach((key, index) => {
                const meta = tabMeta[key];
                const btn = document.createElement("button");
                btn.style.cssText = `border:1px solid ${meta.color}; color:${meta.color}; background:white; padding:5px 10px; border-radius:20px; cursor:pointer; font-size:0.8rem;`;
                btn.innerHTML = `${meta.icon} ${meta.label}`;
                // Pass empty object if tab data missing
                const tabData = (data.tabs && data.tabs[key]) ? data.tabs[key] : {};
                btn.onclick = () => switchLegacyTab(key, tabData, meta.color, data.name, meta.label);
                tabContainer.appendChild(btn);

                if (index === 0) btn.click();
            });
        }

        function switchLegacyTab(key, contentObj, color, venueName, label) {
            const contentEl = document.getElementById("legacyTabContent");
            if (!contentEl) return;

            // Fallback for venueName
            let safeVenueName = venueName;
            if (!safeVenueName) {
                const inputVal = document.getElementById('venueInput').value;
                if (inputVal) safeVenueName = inputVal;
                else {
                    const header = document.querySelector("#legacyContent h3");
                    if (header) safeVenueName = header.innerText;
                }
            }

            // Update Border Color
            contentEl.style.borderLeft = `4px solid ${color}`;

            // Standardized Message (Ignore DB content)
            const html = "æœ€æ–°ã®æƒ…å ±ã‚’Googleãƒãƒƒãƒ—ã§ç¢ºèªã§ãã¾ã™ã€‚<br>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚";

            // Google Maps Search Query
            const searchQuery = `${safeVenueName} å‘¨è¾º ${label}`;
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;

            contentEl.innerHTML = `
                <h4 style="margin-top:0; color:${color};">${label}æƒ…å ±</h4>
                <div style="font-size:0.9rem; line-height:1.6; margin-bottom:15px; color:#555;">${html}</div>
                <div style="text-align:center;">
                    <a href="${mapUrl}" target="_blank" style="display:block; width:100%; box-sizing:border-box; background:${color}; color:white; padding:12px; border-radius:8px; text-decoration:none; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                        ğŸ—ºï¸ Googleãƒãƒƒãƒ—ã§ã€Œ${label}ã€ã‚’æ¤œç´¢
                    </a>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => { renderMissions(); renderJapanMap(); loadStampHistory(); });
    </script>
</body>

</html>
